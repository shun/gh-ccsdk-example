name: AI Code Generation with Claude

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'ã‚³ãƒ¼ãƒ‰ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        default: 'TypeScriptã§Hello Worldã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¦ãã ã•ã„'
      output_file:
        description: 'å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å'
        required: false
        default: 'generated/hello.ts'
  push:
    branches: [ main ]
    paths:
      - 'prompts/**'
  pull_request:
    branches: [ main ]

jobs:
  generate-code:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build TypeScript
      run: npm run build
      
    - name: Generate code with Claude
      env:
        # Anthropic Direct API (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        # AWS Bedrockè¨­å®š
        CLAUDE_CODE_USE_BEDROCK: ${{ secrets.CLAUDE_CODE_USE_BEDROCK }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
        AWS_BEARER_TOKEN_BEDROCK: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
        # å…±é€šè¨­å®š
        INPUT_PROMPT: ${{ github.event.inputs.prompt }}
        OUTPUT_FILE: ${{ github.event.inputs.output_file || 'generated/auto-generated.ts' }}
      run: npm run generate
      
    - name: Commit generated code
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git add generated/ --force
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "AIç”Ÿæˆã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 

          - Claude SDKã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
          - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${{ github.event.inputs.prompt }}
          - å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: ${{ github.event.inputs.output_file }}
          
          ğŸ¤– Generated with Claude Code SDK
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push
        else
          echo "å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi
        
    - name: Upload generated files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-code
        path: generated/
        retention-days: 30
#!/usr/bin/env node

import { query, type SDKMessage } from "@anthropic-ai/claude-code";
import { writeFileSync, mkdirSync } from 'fs';
import { dirname } from 'path';

type CodeGenerationConfig = {
  prompt: string;
  outputFile: string;
  maxTurns?: number;
};

type GeneratedCode = {
  content: string;
  language: string;
  explanation?: string;
  totalCostUsd?: number;
  sessionId?: string;
};

class ClaudeCodeOfficialGenerator {
  async generateCode(config: CodeGenerationConfig): Promise<GeneratedCode> {
    const systemPrompt = `ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
è¦æ±‚ã«å¿œã˜ã¦é«˜å“è³ªãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ãã ã•ã„ï¼š
- TypeScriptã®å ´åˆã¯å‹å®‰å…¨æ€§ã‚’é‡è¦–
- é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’å„ªå…ˆã—ã€å‰¯ä½œç”¨ã‚’æœ€å°é™ã«
- ã‚³ãƒ¼ãƒ‰ã«ã¯é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’å«ã‚ã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è€ƒæ…®ã™ã‚‹
- ãƒ†ã‚¹ã‚¿ãƒ–ãƒ«ãªè¨­è¨ˆã‚’å¿ƒãŒã‘ã‚‹

ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ï¼š
\`\`\`typescript
// ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°
\`\`\`

ã¾ãŸã€ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜ã‚‚ç°¡æ½”ã«å«ã‚ã¦ãã ã•ã„ã€‚`;

    const fullPrompt = `${systemPrompt}

${config.prompt}`;

    try {
      console.log('ğŸš€ å…¬å¼Claude Code SDKã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’é–‹å§‹...');
      
      const messages: SDKMessage[] = [];
      
      for await (const message of query({
        prompt: fullPrompt,
        abortController: new AbortController(),
        options: {
          maxTurns: config.maxTurns || 3,
        },
      })) {
        messages.push(message);
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
        if (message.type === 'assistant') {
          console.log('ğŸ’­ Claude ãŒå¿œç­”ä¸­...');
        } else if (message.type === 'result') {
          console.log(`ğŸ“Š ã‚³ã‚¹ãƒˆ: $${message.total_cost_usd}, ã‚¿ãƒ¼ãƒ³æ•°: ${message.num_turns}`);
        }
      }

      // æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰çµæœã‚’å–å¾—
      const resultMessage = messages.find(m => m.type === 'result');
      const finalResult = resultMessage && 'result' in resultMessage ? resultMessage.result : '';
      
      if (!finalResult) {
        throw new Error('Claude Code SDKã‹ã‚‰ã®å¿œç­”ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }

      const parsed = this.parseResponse(finalResult);
      
      return {
        ...parsed,
        totalCostUsd: resultMessage && 'total_cost_usd' in resultMessage ? resultMessage.total_cost_usd : undefined,
        sessionId: resultMessage?.session_id,
      };
    } catch (error) {
      console.error('ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }

  private parseResponse(response: string): GeneratedCode {
    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/;
    const match = response.match(codeBlockRegex);

    if (!match) {
      // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å…¨æ–‡ã‚’ãã®ã¾ã¾ä½¿ç”¨
      console.warn('âš ï¸ ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¨æ–‡ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚');
      return {
        content: response,
        language: 'typescript',
        explanation: undefined,
      };
    }

    const language = match[1] || 'typescript';
    const content = match[2].trim();
    
    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä»¥å¤–ã®éƒ¨åˆ†ã‚’èª¬æ˜ã¨ã—ã¦æŠ½å‡º
    const explanation = response
      .replace(codeBlockRegex, '')
      .trim()
      .replace(/^\n+/, '')
      .replace(/\n+$/, '');

    return {
      content,
      language,
      explanation: explanation || undefined,
    };
  }

  saveGeneratedCode(code: GeneratedCode, outputPath: string): void {
    try {
      // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
      const dir = dirname(outputPath);
      mkdirSync(dir, { recursive: true });

      // ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      const header = `// Generated by Claude Code SDK (Official)
// Date: ${new Date().toISOString()}
// Session ID: ${code.sessionId || 'unknown'}
// Cost: $${code.totalCostUsd || 'unknown'}
${code.explanation ? `// Description: ${code.explanation}` : ''}

`;

      const fullContent = header + code.content;
      writeFileSync(outputPath, fullContent, 'utf-8');
      
      console.log(`âœ… ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†: ${outputPath}`);
      console.log(`ğŸ”§ ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: Claude Code SDK (Official)`);
      if (code.totalCostUsd) {
        console.log(`ğŸ’° ã‚³ã‚¹ãƒˆ: $${code.totalCostUsd}`);
      }
      if (code.explanation) {
        console.log(`ğŸ“ èª¬æ˜: ${code.explanation}`);
      }
    } catch (error) {
      console.error(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error}`);
      throw error;
    }
  }
}

async function main(): Promise<void> {
  const prompt = process.env.INPUT_PROMPT || 'TypeScriptã§Hello Worldã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¦ãã ã•ã„';
  const outputFile = process.env.OUTPUT_FILE || 'generated/hello.ts';

  console.log('ğŸ¤– å…¬å¼Claude Code SDKã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’é–‹å§‹...');
  console.log(`ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${prompt}`);
  console.log(`ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: ${outputFile}`);

  try {
    const generator = new ClaudeCodeOfficialGenerator();
    
    const config: CodeGenerationConfig = {
      prompt,
      outputFile,
      maxTurns: 3,
    };

    const generatedCode = await generator.generateCode(config);
    generator.saveGeneratedCode(generatedCode, outputFile);

    console.log('ğŸ‰ ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼');
  } catch (error) {
    console.error('âŒ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    process.exit(1);
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿mainã‚’å‘¼ã³å‡ºã—
if (import.meta.url === `file://${process.argv[1]}`) {
  main().catch(console.error);
}

export { ClaudeCodeOfficialGenerator, type CodeGenerationConfig, type GeneratedCode };
// ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

import { writeFileSync, mkdirSync } from 'fs';
import { dirname } from 'path';
import type { GeneratedCode } from '../types/index.js';

/**
 * ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
export class FileWriter {
  /**
   * ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
   */
  static saveGeneratedCode(code: GeneratedCode, outputPath: string): void {
    try {
      // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
      const dir = dirname(outputPath);
      mkdirSync(dir, { recursive: true });

      // ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      const header = this.generateHeader(code);
      const fullContent = header + code.content;
      
      writeFileSync(outputPath, fullContent, 'utf-8');
      
      console.log(`âœ… ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†: ${outputPath}`);
      console.log(`ğŸ”§ ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${code.provider || 'Unknown'}`);
      
      if (code.totalCostUsd) {
        console.log(`ğŸ’° ã‚³ã‚¹ãƒˆ: $${code.totalCostUsd}`);
      }
      
      if (code.explanation) {
        console.log(`ğŸ“ èª¬æ˜: ${code.explanation}`);
      }
    } catch (error) {
      console.error(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error}`);
      throw error;
    }
  }

  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
   */
  private static generateHeader(code: GeneratedCode): string {
    const lines = [
      `// Generated by Claude Code SDK${code.provider ? ` (${code.provider})` : ''}`,
      `// Date: ${new Date().toISOString()}`,
    ];

    if (code.modelName) {
      lines.push(`// Model: ${code.modelName}`);
    }

    if (code.sessionId) {
      lines.push(`// Session ID: ${code.sessionId}`);
    }

    if (code.totalCostUsd) {
      lines.push(`// Cost: $${code.totalCostUsd}`);
    }

    if (code.explanation) {
      lines.push(`// Description: ${code.explanation}`);
    }

    return lines.join('\n') + '\n\n';
  }
}